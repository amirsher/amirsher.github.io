 <!DOCTYPE html>
<html>
<head>
    <title>Bluetooth Echo</title>
    <style>
        #connectB {
            width: 148px;
            font-size: 48px;
            border: none;
            background: transparent;
            text-align: center;
        }
        #main {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 50%;
        }
        #io {
            fill: red;
        }

/* Styles for users who prefer dark mode at the OS level */
        @media (prefers-color-scheme: dark) {

            html, body {
                background-color: #333;
            }
        }
    </style>
</head>
<body>
    <div id="main">
    <!--  <button id="connectB" onclick="connectBTx()" >garage</button>-->

      <button id="connectB" onclick="connectBTx()" title="click to toggle garage door"><svg xmlns="http://www.w3.org/2000/svg">
        <g id="io" viewBox="0 0 128 128">
          <path id="door_frame" d="M64 10.23zm0 0L32.75 26.45 1.5 42.68h9.84v70.86H7.27v4.23H120.7v-4.23h-4.04V42.68h9.84L95.25 26.45 64 10.23zM20.82 42.68h86.35v70.86H20.82V42.68z"></path>
          <path id="box1" d="m 24.8345,51.6419 0,6.6573 78.322,0 0,-6.6573 -78.322,0 z"></path>
          <path id="box2" d="m 24.8345,67.9629 0,6.6573 78.322,0 0,-6.6573 -78.322,0 z"></path>
          <path id="box3" d="m 24.8345,83.1029 0,6.6573 78.322,0 0,-6.6573 -78.322,0 z"></path>
          <path id="box4" d="m 24.8345,98.4249 0,6.6573 78.322,0 0,-6.6573 -78.322,0 z"></path>
        </g>
      </svg>
    </button>

    </div>

  </body>
<script>
    var bluetooth = null;
    // shared UUIDs between MicroPython and JS
    const UART_SERVICE_ID = '6E400001-B5A3-F393-E0A9-E50E24DCCA9E'.toLowerCase();
    const CHARACTERISTIC_TX = '6E400003-B5A3-F393-E0A9-E50E24DCCA9E'.toLowerCase();
    const CHARACTERISTIC_RX = '6E400002-B5A3-F393-E0A9-E50E24DCCA9E'.toLowerCase();

  /*
  async function connectBT() {
    navigator.bluetooth.requestDevice({ filters: [{ name: "mpy-uart" },] })
    .then(device => device.gatt.connect())
    .then(server => server.getPrimaryService(UART_SERVICE_ID))
    .then(service => service.getCharacteristic(CHARACTERISTIC_RX))
    .then(characteristic => {
      // Writing 1 is the signal to reset energy expended.
    //  const resetEnergyExpended = Uint8Array.of(1);
        let encoder = new TextEncoder(); // Encode string to bytes
    //    let data = encoder.encode(textToWrite);
        let data = encoder.encode('Toggle');
      return characteristic.writeValue(data);
    })
    .then(_ => {
      console.log('Energy expended has been reset.');
    location.reload();
    })
    .catch(error => { console.error(error); });
  }
  */

  var device = null;
  let  gatt, service, characteristic;

  async function connectBTx() {
      try {
          if (!device) {
              device = await navigator.bluetooth.requestDevice({
                filters: [{ name: ["mpy-uart"] }],
              });
                device.addEventListener('gattserverdisconnected', onDisconnected);
              gatt = await device.gatt.connect();
              service = await gatt.getPrimaryService(UART_SERVICE_ID);
              characteristic = await service.getCharacteristic(CHARACTERISTIC_RX);
          }
//              console.log(device.gatt.connected);
              document.getElementById("io").style.fill = 'green';
              let encoder = new TextEncoder(); // Encode string to bytes
              //    let data = encoder.encode(textToWrite);
              let data = encoder.encode('Toggle');
              await characteristic.writeValue(data);

          //    await device.gatt.disconnect()

      } catch (error) {
            console.error(error);
        // Expected output: ReferenceError: nonExistentFunction is not defined
            onDisconnected();
      }
  }

  function onDisconnected() {
      device = null;
      gatt = null;
      service = null;
      characteristic = null;
      document.getElementById("io").style.fill = 'red';
  }

</script>
</html>
